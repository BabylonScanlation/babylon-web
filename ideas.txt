
================================================================================
[FUTURO] AUTOMATIZACI칍N TOTAL: CREACI칍N DE SERIES Y TOPICS DE TELEGRAM DESDE WEB
================================================================================

OBJETIVO:
Eliminar la necesidad de entrar manualmente a Telegram para crear un "Tema" (Topic) cada vez que se inicia una nueva serie. Centralizar todo el proceso de creaci칩n en el panel de administraci칩n web (`/admin`).

SITUACI칍N ACTUAL (MANUAL):
1. El admin entra a Telegram -> Grupo.
2. Crea un Tema manualmente.
3. Sube un .zip al tema.
4. El backend detecta el archivo, extrae el ID del tema y crea la serie en la BD (a veces con nombre temporal).

SITUACI칍N FUTURA (AUTOM츼TICA - WEB):
1. El admin entra a `Gestionar Series` en la web.
2. Hace clic en "Crear Nueva Serie".
3. Ingresa el T칤tulo y sube la Portada.
4. Al guardar:
   a) El backend llama a la API de Telegram: `createForumTopic(chat_id, name=TituloSerie)`.
   b) Telegram devuelve el `message_thread_id` (ID 칰nico del tema) y el `name`.
   c) El backend crea la entrada en la base de datos D1 inmediatamente con:
      - `title`: El ingresado en la web.
      - `telegram_topic_id`: El ID devuelto por Telegram.
      - `slug`: Generado autom치ticamente (ej: `mi-nueva-serie`).
      - `cover_image_url`: La portada subida a R2.

RESULTADO:
- La serie queda creada y vinculada perfectamente desde el segundo 0.
- El Tema en Telegram aparece autom치ticamente con el nombre correcto.
- Subir cap칤tulos futuros (ZIPs) es trivial: el bot ya sabe que ese `topic_id` corresponde a esa serie en la BD.

REQUISITOS T칄CNICOS (API TELEGRAM):
- M칠todo: `createForumTopic`
- Documentaci칩n: https://core.telegram.org/bots/api#createforumtopic
- Par치metros clave:
  - `chat_id`: ID del Supergrupo.
  - `name`: T칤tulo de la serie (1-128 caracteres).
  - `icon_color` (Opcional): Color del icono del tema (RGB integer).
  - `icon_custom_emoji_id` (Opcional): Emoji personalizado como icono.
- Permisos del Bot: Debe ser ADMINISTRADOR del grupo y tener el permiso `can_manage_topics`.
- Tipo de Grupo: Debe ser un Supergrupo con la funcionalidad de "Temas" habilitada.

IMPLEMENTACI칍N SUGERIDA:
1. Crear un endpoint API en Astro: `/api/admin/series/create`.
2. Este endpoint recibe los datos del formulario web.
3. Llama a `https://api.telegram.org/bot<TOKEN>/createForumTopic`.
4. Recibe el JSON de respuesta con el objeto `ForumTopic`.
5. Inserta en D1 (`INSERT INTO Series ...`).
6. Devuelve 칠xito al frontend.

VENTAJAS A LARGO PLAZO:
- Cero fricci칩n: No sales de la web para gestionar contenido.
- Datos limpios: La serie nace con su nombre real, slug correcto y portada, sin nombres temporales tipo "serie-400".
- Escalabilidad: Permite que moderadores sin acceso total al Telegram puedan crear series si se les da permiso en la web.

### 游 Sistema H칤brido de Conteo de Vistas (Cascada de Identidad)
**Objetivo:** Contabilizar vistas 칰nicas y mantener el historial de lectura de usuarios an칩nimos ("Guest") incluso si cambian de IP o borran cookies.

**Estrategia:** Modelo de prioridad en 3 niveles (Cookie > Fingerprint > IP).

#### 1. Base de Datos (Schema)
- **Nueva Tabla `AnonymousUsers`:**
  - `guest_id` (PK, UUID): Identificador principal del usuario an칩nimo.
  - `fingerprint_hash` (Index): Hash 칰nico del dispositivo (Hardware/Browser).
  - `last_ip`: Para validaci칩n de seguridad (opcional).
  - `created_at` / `updated_at`.
- **Modificaci칩n `ChapterViews`:**
  - Cambiar unique constraint de `(chapter_id, ip_address)` a `(chapter_id, guest_id)`.

#### 2. L칩gica del Frontend (Cliente)
- Usar librer칤a ligera (ej: FingerprintJS Free) para generar un hash del navegador.
- Enviar este hash (`fingerprint`) junto con el `chapterId` al endpoint `/api/chapters/view`.

#### 3. L칩gica del Backend (Flujo de "Auto-recuperaci칩n")
Al recibir una petici칩n de vista:
1. **Nivel 1 (Cookie Check):**
   - 쮼xiste cookie `guest_id`? -> **S칈**: Usar ese ID. Fin.
   - **NO**: Pasar al Nivel 2.
2. **Nivel 2 (Fingerprint Recovery):**
   - Buscar en tabla `AnonymousUsers` por `fingerprint_hash`.
   - 쮼xiste coincidencia? -> **S칈**: El usuario borr칩 cookies. Recuperar su `guest_id` antiguo y **restaurar la cookie** (Set-Cookie).
   - **NO**: Es un dispositivo nuevo. Generar nuevo `guest_id` y guardar en BD junto con el hash.
3. **Registro de Vista:**
   - Insertar en `ChapterViews` usando el `guest_id`.
   - Si la inserci칩n es exitosa (no exist칤a), incrementar contador `views` en `Chapters`.

**Beneficio:** Evita conteo duplicado por IPs din치micas y recupera al usuario si limpia el navegador.

### 游눠 Nuevas Funcionalidades Propuestas (Roadmap)

#### 1. M칩dulo "Continuar Leyendo" (Estilo Netflix)
**Objetivo:** Mostrar en la Home la 칰ltima serie que el usuario estaba leyendo y el bot칩n directo al siguiente cap칤tulo.
**Requisito:** Requiere haber implementado el sistema de `AnonymousUsers` (Guest ID).

* **L칩gica Backend:**
    * Endpoint: `/api/user/progress`.
    * Query: Buscar en `ChapterViews` filtrando por el `guest_id` actual. Ordenar por `viewed_at` DESC.
    * Cruzar con tabla `Chapters` para ver si existe un cap칤tulo con `chapterNumber > ultimo_visto`.
* **Frontend (Componente Astro):**
    * Si hay progreso: Mostrar tarjeta ancha ("Hero") con la portada de la serie, t칤tulo: *"Continuar viendo Temporada 1..."* y bot칩n *"Leer Cap. X"*.
    * Si no hay progreso: Mostrar recomendaci칩n aleatoria o popular.

#### 2. Notificaciones Web Push (Sin App M칩vil)
**Objetivo:** Avisar al usuario cuando sale un cap칤tulo nuevo de sus series favoritas.

* **Tecnolog칤a:** Service Workers + API Push (Nativa del navegador) + Cloudflare Workers.
* **Base de Datos:**
    * Nueva tabla `PushSubscriptions`: `endpoint`, `p256dh`, `auth`, `guest_id` (para asociar a usuario).
    * Nueva tabla `SeriesFollows`: `series_id`, `guest_id`.
* **Flujo:**
    1.  Bot칩n "游댒 Seguir" en la portada del manga.
    2.  Al hacer clic, pedir permiso al navegador y guardar la suscripci칩n en BD.
    3.  En el webhook de Telegram (`telegram-webhook.ts`): Cuando se procesa un cap칤tulo exitosamente, buscar suscriptores de esa serie y enviar la notificaci칩n usando librer칤a `web-push`.

#### 3. Selector de Modo de Lectura (Webtoon vs. Cl치sico)
**Objetivo:** Atraer a lectores puristas del manga que odian el scroll infinito vertical.

* **Frontend (Componente Lector):**
    * Estado local (Store/Signal): `readingMode = 'vertical' | 'paginated'`.
    * **Modo Vertical (Default):** `<img />` uno debajo de otro (lo actual).
    * **Modo Paginado:**
        * Contenedor que muestra 1 imagen a la vez (o 2 en landscape).
        * Zonas de clic invisibles: Izquierda (Siguiente), Derecha (Anterior) - (configurable para sentido de lectura japon칠s LTR/RTL).
        * Precarga de imagen siguiente para evitar esperas.
    * Guardar preferencia en `localStorage`.

#### 4. Dashboard de Anal칤ticas Avanzadas (Admin)
**Objetivo:** Ver el rendimiento real del sitio m치s all치 de una simple tabla de n칰meros.

* **Librer칤a Gr치fica:** `Chart.js` o `Recharts` (Ligeras).
* **Backend (Nuevos Endpoints Admin):**
    * `/api/admin/stats/daily-views`: Group by `viewed_at` (d칤a).
    * `/api/admin/stats/top-series`: Top 10 series con m치s vistas esta semana.
    * `/api/admin/stats/geo`: Usar `request.cf.country` (Cloudflare) para contar visitas por pa칤s y guardar en una tabla agregada `DailyGeoStats`.
* **UI Admin:**
    * Panel con tarjetas: "Vistas Hoy", "Usuarios Activos", "Serie del Mes".
    * Gr치fico de l칤neas para tendencia de tr치fico mensual.

---

### Tareas adicionales
- [ ] IMPLEMENTAR SISTEMA AD-SHIELD H칈BRIDO (Monetizaci칩n + Detecci칩n)
    *   Integrar scripts de Monetag con tecnolog칤a Anti-AdBlock (Service Workers).
    *   Crear componente `AdBlockManager.svelte` para gestionar la detecci칩n de bloqueadores.
    *   Dise침o H칤brido:
        *   Fase 1 (Aviso): Notificaci칩n no intrusiva pidiendo apoyo al detectar AdBlock.
        *   Fase 2 (Bloqueo): Modal persistente (estilo AuthModal) que impida la lectura si el bloqueo persiste.
    *   A침adir bypass para usuarios con suscripci칩n/donantes (futuro).
    *   Configurar archivo de verificaci칩n en `public/` y scripts en el `<head>` del Layout global.
