--- 
let editingNewsId: string | null = null;
let initialNewsData = {
  title: '',
  content: '',
  status: 'draft',
};
---

<form
  class="bg-white shadow-md rounded-lg p-4 space-y-4"
>
  <input type="hidden" name="newsId" value={editingNewsId} />

  <div>
    <label for="title" class="block text-sm font-medium text-gray-700"
      >Título</label
    >
    <input
      type="text"
      id="title"
      name="title"
      value={initialNewsData.title}
      required
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
    />
  </div>

  <div>
    <label for="content" class="block text-sm font-medium text-gray-700"
      >Contenido</label
    >
    <textarea
      id="content"
      name="content"
      rows="5"
      required
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
      >{initialNewsData.content}</textarea
    >
  </div>

  <div>
    <label for="status" class="block text-sm font-medium text-gray-700"
      >Estado</label
    >
    <select
      id="status"
      name="status"
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
    >
      <option value="draft" selected={initialNewsData.status === 'draft'}
        >Borrador</option
      >
      <option
        value="published"
        selected={initialNewsData.status === 'published'}>Publicado</option
      >
    </select>
  </div>

  <div>
    <label for="seriesId" class="block text-sm font-medium text-gray-700"
      >ID de Serie (opcional)</label
    >
    <input
      type="text"
      id="seriesId"
      name="seriesId"
      value=""
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
      placeholder="Dejar vacío para noticias globales"
    />
  </div>

  <div>
    <label for="image" class="block text-sm font-medium text-gray-700"
      >Imagen (opcional)</label
    >
    <input
      type="file"
      id="image"
      name="image"
      accept="image/*"
      class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
    />
  </div>

  <button
    type="submit"
    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
  >
    Guardar Noticia
  </button>
</form>

<script>
  // Client-side script to handle editing news items
  import { logError } from '@lib/logError';

  const handleEditNews = async (event: Event) => {
    const customEvent = event as CustomEvent;
    const newsId = customEvent.detail;
    const form = document.querySelector('form');
    if (!form) return;

    try {
      const response = await fetch(`/api/admin/news/${newsId}`);
      if (!response.ok) {
        throw new Error('Failed to fetch news item');
      }
      const newsItem = await response.json();

      // Populate the form
      (form.elements.namedItem('newsId') as HTMLInputElement).value =
        newsItem.id;
      (form.elements.namedItem('title') as HTMLInputElement).value =
        newsItem.title;
      (form.elements.namedItem('content') as HTMLTextAreaElement).value =
        newsItem.content;
      (form.elements.namedItem('status') as HTMLSelectElement).value =
        newsItem.status;
      (form.elements.namedItem('seriesId') as HTMLInputElement).value =
        newsItem.seriesId || ''; // Populate seriesId

      // Scroll to form
      form.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
      const newsIdForLog = newsId; // Capture for log context
      logError(error, 'Error al cargar noticia para editar', { newsId: newsIdForLog });
      alert('Error al cargar la noticia para editar.');
    }
  };

  document.addEventListener('edit-news', handleEditNews);

  const form = document.querySelector('form');
  const statusEl = document.getElementById('form-status');
  const newsIdInput = document.querySelector('input[name="newsId"]') as HTMLInputElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!(form instanceof HTMLFormElement)) return;

    const formData = new FormData(form);
    const newsId = newsIdInput?.value || null;
    const title = formData.get('title')?.toString().trim();
    const content = formData.get('content')?.toString().trim();
    const status = formData.get('status')?.toString() as 'draft' | 'published';
    const seriesId = formData.get('seriesId')?.toString() || null;
    const imageFile = formData.get('image') as File | null;

    if (!title || !content || !status) {
      if (statusEl) {
        statusEl.textContent = 'Título, contenido y estado no pueden estar vacíos.';
        statusEl.className = 'error';
      }
      return;
    }

    if (statusEl) {
      statusEl.textContent = newsId ? 'Actualizando noticia...' : 'Creando noticia...';
      statusEl.className = 'loading';
    }

    try {
      let newsResponse;
      let newNewsId = newsId;

      if (newsId) {
        // Update existing news
        newsResponse = await fetch(`/api/admin/news/${newsId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content, status, seriesId }),
        });
      } else {
        // Create new news
        newsResponse = await fetch('/api/admin/news', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content, status, seriesId }),
        });
        const newNews = await newsResponse.json();
        newNewsId = newNews.id;
      }

      if (!newsResponse.ok) {
        const errorData = await newsResponse.text();
        throw new Error(
          `Error al ${newsId ? 'actualizar' : 'crear'} la noticia: ${newsResponse.status} ${errorData}`
        );
      }

      // Step 2: If there's an image, upload it.
      if (imageFile instanceof File && imageFile.size > 0 && newNewsId) {
        if (statusEl) statusEl.textContent = 'Subiendo imagen...';
        const imageFormData = new FormData();
        imageFormData.append('image', imageFile);
        imageFormData.append('newsId', newNewsId);

        const uploadResponse = await fetch('/api/admin/news/upload-image', {
          method: 'POST',
          body: imageFormData,
        });

        if (!uploadResponse.ok) {
          throw new Error(
            'La noticia se guardó, pero falló la subida de la imagen.'
          );
        }
      }

      if (statusEl) {
        statusEl.textContent = newsId ? 'Noticia actualizada con éxito.' : 'Noticia creada con éxito.';
        statusEl.className = 'success';
      }
      form.reset();
      if (newsIdInput) newsIdInput.value = ''; // Clear hidden newsId after submission
      
      // Dispatch custom event to tell the feed to refresh
      document.dispatchEvent(new CustomEvent('refresh-news-feed'));
    } catch (error) {
      const newsIdForLog = newsId;
      const titleForLog = title;
      const statusForLog = status;
      const seriesIdForLog = seriesId;
      logError(error, `Fallo al ${newsId ? 'actualizar' : 'crear'} noticia`, { newsId: newsIdForLog, title: titleForLog, status: statusForLog, seriesId: seriesIdForLog });
      if (statusEl) {
        if (error instanceof Error) {
          statusEl.textContent = error.message || `Fallo al ${newsId ? 'actualizar' : 'crear'} la noticia.`;
        } else {
          statusEl.textContent = `Fallo al ${newsId ? 'actualizar' : 'crear'} la noticia.`;
        }
        statusEl.className = 'error';
      }
    } finally {
      setTimeout(() => {
        if (statusEl) {
          statusEl.textContent = '';
          statusEl.className = '';
        }
      }, 7000);
    }
  });
</script>
