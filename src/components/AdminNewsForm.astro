---
import { getDB, createNews, updateNews, addNewsImage } from '../lib/db';

const db = getDB(Astro.locals.runtime.env);

let editingNewsId: string | null = null;
let initialNewsData = {
  title: '',
  content: '',
  status: 'draft',
};

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const newsId = formData.get('newsId') as string | null;
  const title = formData.get('title') as string;
  const content = formData.get('content') as string;
  const status = formData.get('status') as 'draft' | 'published';
  const seriesId = formData.get('seriesId') as string | null; // Added seriesId
  const imageFile = formData.get('image') as File | null;

  if (newsId) {
    // Update existing news
    await updateNews(db, newsId, { title, content, status, seriesId: seriesId || null }); // Pass seriesId
    // Handle image upload if provided
    if (imageFile && imageFile.size > 0) {
      const uploadResponse = await fetch('/api/admin/news/upload-image', {
        method: 'POST',
        body: formData, // Pass the whole formData for image upload
      });
      if (uploadResponse.ok) {
        const { r2Key } = await uploadResponse.json();
        await addNewsImage(db, {
          newsId,
          r2Key,
          altText: title, // Use title as alt text for now
          displayOrder: 0, // Assuming single image for now
        });
      } else {
        console.error('Error uploading image:', await uploadResponse.text());
      }
    }
  } else {
    // Create new news
    const newNews = await createNews(db, {
      title,
      content,
      publishedBy: Astro.locals.user?.uid || 'admin',
      status,
      seriesId: seriesId || null, // Pass seriesId
    });
    // Handle image upload if provided
    if (imageFile && imageFile.size > 0) {
      const uploadFormData = new FormData();
      uploadFormData.append('image', imageFile);
      const uploadResponse = await fetch('/api/admin/news/upload-image', {
        method: 'POST',
        body: uploadFormData,
      });
      if (uploadResponse.ok) {
        const { r2Key } = await uploadResponse.json();
        await addNewsImage(db, {
          newsId: newNews.id,
          r2Key,
          altText: title,
          displayOrder: 0,
        });
      } else {
        console.error('Error uploading image:', await uploadResponse.text());
      }
    }
  }
  // Redirect to refresh the page and list
  return Astro.redirect(Astro.url.pathname);
}
---

<form method="POST" enctype="multipart/form-data" class="bg-white shadow-md rounded-lg p-4 space-y-4">
  <input type="hidden" name="newsId" value={editingNewsId} />

  <div>
    <label for="title" class="block text-sm font-medium text-gray-700">Título</label>
    <input
      type="text"
      id="title"
      name="title"
      value={initialNewsData.title}
      required
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
    />
  </div>

  <div>
    <label for="content" class="block text-sm font-medium text-gray-700">Contenido</label>
    <textarea
      id="content"
      name="content"
      rows="5"
      required
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
    >{initialNewsData.content}</textarea>
  </div>

  <div>
    <label for="status" class="block text-sm font-medium text-gray-700">Estado</label>
    <select
      id="status"
      name="status"
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
    >
      <option value="draft" selected={initialNewsData.status === 'draft'}>Borrador</option>
      <option value="published" selected={initialNewsData.status === 'published'}>Publicado</option>
    </select>
  </div>

  <div>
    <label for="seriesId" class="block text-sm font-medium text-gray-700">ID de Serie (opcional)</label>
    <input
      type="text"
      id="seriesId"
      name="seriesId"
      value=""
      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
      placeholder="Dejar vacío para noticias globales"
    />
  </div>

  <div>
    <label for="image" class="block text-sm font-medium text-gray-700">Imagen (opcional)</label>
    <input
      type="file"
      id="image"
      name="image"
      accept="image/*"
      class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
    />
  </div>

  <button
    type="submit"
    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
  >
    Guardar Noticia
  </button>
</form>

<script>
  // Client-side script to handle editing news items
  document.addEventListener('edit-news', async (event: CustomEvent) => {
    const newsId = event.detail;
    const form = document.querySelector('form');
    if (!form) return;

    try {
      const response = await fetch(`/api/admin/news/${newsId}`);
      if (!response.ok) {
        throw new Error('Failed to fetch news item');
      }
      const newsItem = await response.json();

      // Populate the form
      (form.elements.namedItem('newsId') as HTMLInputElement).value = newsItem.id;
      (form.elements.namedItem('title') as HTMLInputElement).value = newsItem.title;
      (form.elements.namedItem('content') as HTMLTextAreaElement).value = newsItem.content;
      (form.elements.namedItem('status') as HTMLSelectElement).value = newsItem.status;
      (form.elements.namedItem('seriesId') as HTMLInputElement).value = newsItem.seriesId || ''; // Populate seriesId

      // Scroll to form
      form.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
      console.error('Error loading news for editing:', error);
      alert('Error al cargar la noticia para editar.');
    }
  });
</script>