---
// src/pages/admin/series.astro
import Layout from '../../layouts/Layout.astro';
import AdminSeriesManager from '../../components/AdminSeriesManager.astro';
import AdminThumbnailCropperModalSvelte from '../../components/AdminThumbnailCropperModal.svelte';
import { logError } from '../../lib/logError';

const r2PublicUrlAssets = Astro.locals.runtime.env.R2_PUBLIC_URL_ASSETS;

interface Chapter {
  id: number;
  chapter_number: number;
  title: string | null;
  telegram_file_id: string;
  url_portada: string | null;
}
interface Series {
  id: number;
  title: string;
  description: string;
  cover_image_url: string | null;
  slug: string;
  chapters: Chapter[];
  status: string | null;
  type: string | null;
  genres: string | null;
  author: string | null;
  artist: string | null;
  published_by: string | null;
  alternative_names: string | null;
  serialized_by: string | null;
  is_hidden: boolean;
}

let allSeries: any[] = [];
const success = Astro.url.searchParams.get('success');
let error = Astro.url.searchParams.get('error');

try {
  const response = await fetch(
    new URL('/api/admin/series-with-chapters', Astro.url),
    {
      headers: Astro.request.headers,
    }
  );

  if (response.ok) {
    allSeries = await response.json();
  } else {
    error = `Error al cargar las series: ${response.statusText}`;
  }
} catch (e) {
  const errorForLog = e; // Explicitly define for log context
  logError(errorForLog, 'Error al cargar las series para el panel de administración');
  error = 'No se pudo conectar con la API para cargar las series.';
}
---

<Layout title="Gestionar Series">

  <main class="admin-container">
    <a href="/admin" class="back-link">&larr; Volver al Panel</a>
    <h1>Gestionar Series y Capítulos</h1>
    <p class="description">
      Aquí puedes editar la información de las series, ajustar las miniaturas de portada y gestionar los capítulos individuales.
    </p>

    {success && <p class="success-message">{success}</p>}
    {error && <p class="error-message">{error}</p>}

    <input 
      type="text" 
      id="series-search" 
      placeholder="Buscar serie por título..." 
      class="search-input"
    />

    <div id="series-list">
    {
      allSeries.length > 0 ? (
        allSeries.map((series) => (
          <AdminSeriesManager series={series} r2PublicUrlAssets={r2PublicUrlAssets} />
        ))
      ) : (
        <div class="empty-state">
          <h3>No hay series</h3>
          <p>No se encontraron series para mostrar.</p>
        </div>
      )
    }
    </div>
  </main>

  <AdminThumbnailCropperModalSvelte client:load />

  <script>
    const searchInput = document.getElementById('series-search') as HTMLInputElement;
    const seriesList = document.getElementById('series-list');

    if (searchInput && seriesList) {
      searchInput.addEventListener('input', (e) => {
        const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
        const seriesItems = seriesList.querySelectorAll('.series-details');

        seriesItems.forEach((item) => {
          const summary = item.querySelector('summary');
          if (summary) {
            const title = summary.textContent?.toLowerCase() || '';
            if (title.includes(searchTerm)) {
              (item as HTMLElement).style.display = '';
            } else {
              (item as HTMLElement).style.display = 'none';
            }
          }
        });
      });
    }
  </script>

  <style>
    /* ... existing styles ... */
    .search-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid #444; /* Borde más grueso y visible */
      background-color: #0a0a0a; /* Fondo más oscuro para contraste */
      color: var(--font-color);
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      margin-bottom: 2rem; /* Margen aplicado directamente al input */
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.15);
      background-color: #000;
    }

    .search-input::placeholder {
      color: #666;
    }
  </style>
</Layout>
