---
// src/pages/admin/users.astro
import Layout from '../../layouts/Layout.astro';

const { user, runtime } = Astro.locals;
const superAdminUid = runtime.env.SUPER_ADMIN_UID;

// Solo el Super Admin puede acceder a esta página
if (!user?.isAdmin || user.uid !== superAdminUid) {
  return Astro.redirect('/admin?error=No tienes permiso para gestionar usuarios.');
}

const success = Astro.url.searchParams.get('success');
const error = Astro.url.searchParams.get('error');

interface AdminUser {
  uid: string;
}

let admins: AdminUser[] = [];
try {
  const response = await fetch(new URL('/api/admin/users', Astro.url));
  if (response.ok) {
    admins = await response.json();
  } else {
    console.error('Error fetching admins:', await response.text());
  }
} catch (e) {
  console.error('Error fetching admins:', e);
}
---

<Layout title="Gestionar Administradores">
  <main class="admin-container">
    <h1>Gestionar Administradores</h1>

    {success && <p class="success-message">{success}</p>}
    {error && <p class="error-message">{error}</p>}

    <div class="admin-section">
      <h2>Añadir Nuevo Administrador</h2>
      <form action="/api/admin/users" method="post" class="user-form">
        <label for="uid">UID de Firebase del Usuario</label>
        <input type="text" id="uid" name="uid" required />
        <button type="submit">Añadir Administrador</button>
      </form>
    </div>

    <div class="admin-section">
      <h2>Administradores Actuales</h2>
      <ul class="user-list">
        {admins.map(admin => (
          <li>
            <span>{admin.uid}</span>
            <form action="/api/admin/users" method="post">
              <input type="hidden" name="_method" value="DELETE" />
              <input type="hidden" name="uid" value={admin.uid} />
              <button type="submit" class="delete-btn">Eliminar</button>
            </form>
          </li>
        ))}
      </ul>
    </div>
  </main>
</Layout>

<style>
  .admin-container {
    padding: 2rem;
    max-width: 900px;
    margin: 0 auto;
    color: #fff;
  }
  h1, h2 {
    border-bottom: 1px solid #444;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }
  .admin-section {
    background-color: var(--card-background);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }
  .user-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .user-form input {
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid #555;
    background-color: #222;
    color: #fff;
  }
  .user-form button {
    padding: 0.75rem;
    background-color: var(--accent-color);
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    align-self: flex-start;
  }
  .user-list {
    list-style: none;
    padding: 0;
  }
  .user-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #333;
  }
  .user-list li:last-child {
    border-bottom: none;
  }
  .delete-btn {
    padding: 0.5rem 1rem;
    background-color: #c0392b;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .success-message,
  .error-message {
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 4px;
    text-align: center;
  }
  .success-message {
    background-color: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
  }
  .error-message {
    background-color: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
  }
</style>